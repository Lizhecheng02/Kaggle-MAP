#!/bin/bash
set -euo pipefail

# 8 张卡一一对应
gpus=(0 1 2 3 4 5 6 7)

# version 固定为 1..8（你也可以手动改）
vers=(1 2 3 4 5 6 7 8)

# 下面四个数组请按你的“允许的组合”填好，每个长度都必须是 8
# 模型名：可在 "Qwen/Qwen3-8B" 和 "Qwen/Qwen3-4B" 中任选并按顺序填
models=("Qwen/Qwen3-4B-Instruct-2507" "Qwen/Qwen3-4B-Instruct-2507" "Qwen/Qwen3-4B-Instruct-2507" "Qwen/Qwen3-4B-Instruct-2507" "Qwen/Qwen3-4B-Instruct-2507" "Qwen/Qwen3-4B-Instruct-2507" "Qwen/Qwen3-4B-Instruct-2507" "Qwen/Qwen3-4B-Instruct-2507")

# r、mid、end：按你认可的组合逐项对应填写
rs=(16 16 16 16 16 16 16 16)
mids=(1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0)
ends=(1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0)

# new dropout array
dropouts=(0.05 0.05 0.04 0.04 0.03 0.03 0.01 0.01)

# 简单的长度校验
n=${#vers[@]}
if [[ $n -ne 8 || $n -ne ${#gpus[@]} || $n -ne ${#models[@]} || $n -ne ${#rs[@]} || $n -ne ${#mids[@]} || $n -ne ${#ends[@]} ]]; then
  echo "数组长度不一致或不是 8，请检查！"
  exit 1
fi

mkdir -p logs configs

for ((i=0; i<8; i++)); do
  gpu=${gpus[$i]}
  ver=${vers[$i]}
  model=${models[$i]}
  r=${rs[$i]}
  mid=${mids[$i]}
  end=${ends[$i]}
  dropout=${dropouts[$i]}

  short_model=$(basename "$model")
  log_file="logs/ver${ver}_r${r}_${short_model}_mid${mid}_end${end}.log"
  cfg_file="configs/ver${ver}_r${r}_${short_model}_mid${mid}_end${end}.txt"

  echo "Launching: GPU=$gpu ver=$ver r=$r model=$model mid=$mid end=$end"
  echo " -> log: $log_file"
  echo " -> cfg: $cfg_file"

  # 保存本次运行配置（便于复现）
  cat > "$cfg_file" <<EOF
ver: $ver
model_name: $model
max_len: 300
cv_fold: 5
cv_seed: 42
r: $r
lora_alpha: 32
lr: 2.5e-4
dropout: $dropout
epochs: 2
lr_scheduler: linear
beta_scheduler: step
start: 1.0
mid: $mid
end: $end
warmup_frac: 1.0
gpu: $gpu
EOF

  # 启动并记录日志（8 个进程并行，每张卡一个）
  CUDA_VISIBLE_DEVICES=$gpu python code_v1.py \
    --ver "$ver" \
    --model_name "$model" \
    --max_len 300 \
    --cv_fold 5 \
    --cv_seed 42 \
    --r "$r" \
    --lora_alpha 32 \
    --lr 2.5e-4 \
    --dropout $dropout \
    --epochs 2 \
    --lr_scheduler linear \
    --beta_scheduler step \
    --start 1.0 \
    --mid "$mid" \
    --end "$end" \
    --warmup_frac 1.0 \
    > "$log_file" 2>&1 &
done

wait
echo "全部 8 个任务已完成启动；日志在 ./logs，配置在 ./configs"