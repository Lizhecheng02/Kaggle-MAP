# MAP@3スコア向上のための改良計画（2025年7月12日）

## 現状分析
- 現在のモデル：XGBoost with GPU optimization
- 特徴量：TF-IDF + 数学的特徴量
- 課題：MAP@3が情報検索型の評価指標であり、ロングテール問題（出現頻度1回のラベル）への対処が必要

## 改良案（優先度順）

### 1. 検索型アプローチの導入【最優先】
#### 1.1 Semantic Embeddings
- **実装内容**：
  - Sentence-BERT（多言語対応版）を使用して意味的埋め込みを生成
  - 質問、回答、説明を個別に埋め込み、結合ベクトルも作成
  - 埋め込みベクトルをFaissで高速検索可能にする

#### 1.2 類似度ベースの予測
- **実装内容**：
  - コサイン類似度で最も類似したk個の訓練例を検索
  - 検索された例の誤解ラベルの分布から予測確率を計算
  - TF-IDFとSemantic Embeddingの両方で検索し、結果を統合

#### 1.3 ハイブリッド予測
- **実装内容**：
  - XGBoostの予測確率：70%
  - 検索ベースの予測確率：30%
  - 重みは検証データで最適化

### 2. ロングテール問題への対処【高優先】
#### 2.1 Few-shot Learning
- **実装内容**：
  - 出現頻度が5回以下のラベルを「希少ラベル」として特定
  - 希少ラベルについては、類似例からの転移学習を重視
  - プロトタイプネットワークの概念を応用

#### 2.2 階層的分類
- **実装内容**：
  ```
  Stage 1: Category予測（True/False × Correct/Misconception/Neither）
  Stage 2: 各Categoryごとに専門化されたMisconception予測モデル
  ```
  - カテゴリごとに異なる特徴量の重要度を学習

#### 2.3 重み付け学習
- **実装内容**：
  - クラス重みを頻度の逆数で設定
  - Focal Lossの概念を取り入れた損失関数の調整
  - 希少ラベルのサンプルをオーバーサンプリング

### 3. データ拡張戦略【中優先】
#### 3.1 パラフレージング
- **実装内容**：
  - T5やGPT系モデルを使用して説明文の言い換え生成
  - 数学的意味を保持しながらバリエーションを増やす
  - 各訓練例から2-3個のバリエーションを生成

#### 3.2 合成データ生成
- **実装内容**：
  - 誤解パターンのテンプレートを作成
  - 例：「分数の大小比較」「小数の桁数誤解」など
  - テンプレートに基づいて新しい問題と誤解を生成

#### 3.3 ノイズ注入
- **実装内容**：
  - 単語の順序入れ替え（意味を保持）
  - 同義語置換
  - 数値の表記揺れ（「1/2」→「0.5」→「half」）

### 4. 特徴量の強化【中優先】
#### 4.1 数学記号の高度な抽出
- **実装内容**：
  ```python
  - 複雑な分数表現: a/b + c/d
  - 指数表現: x^2, x²
  - 根号: √x, sqrt(x)
  - 不等号: <, >, ≤, ≥
  - 数学的関係: proportional, inverse
  ```

#### 4.2 誤解パターンの辞書
- **実装内容**：
  - よくある誤解パターンをルールベースで検出
  - 「大きい数字＝大きい値」の誤解検出
  - 「分母が大きい＝分数が大きい」の誤解検出

#### 4.3 クロス特徴
- **実装内容**：
  - 質問と回答の数値的不一致
  - 説明と回答の論理的矛盾
  - 質問タイプと誤解タイプの相関

### 5. モデルアンサンブル【低優先】
#### 5.1 多様なモデルの組み合わせ
- **モデル構成**：
  - XGBoost（現在のモデル）
  - LightGBM（カテゴリ特徴量に強い）
  - CatBoost（順序を考慮）
  - Neural Network（深い特徴学習）

#### 5.2 スタッキング
- **実装内容**：
  - 各モデルの予測確率を特徴量として使用
  - メタ学習器（ロジスティック回帰）で最終予測
  - クロスバリデーションでオーバーフィットを防止

## 実装スケジュール
1. **Phase 1（即座に実装）**：検索型アプローチ
2. **Phase 2（1日後）**：ロングテール対策
3. **Phase 3（2日後）**：データ拡張
4. **Phase 4（3日後）**：特徴量強化とアンサンブル

## 期待される効果
- 検索型アプローチ：MAP@3を+15-20%向上
- ロングテール対策：希少ラベルの予測精度を大幅改善
- データ拡張：過学習を防ぎ、汎化性能を向上
- 全体として：MAP@3スコア95以上を達成可能

## 技術的な考慮事項
- GPUメモリ：埋め込みベクトルのサイズに注意
- 計算時間：検索処理の最適化が必要
- 再現性：ランダムシードの固定と結果の保存