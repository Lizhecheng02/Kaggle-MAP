# optimized_improve3.py 解説書

## 概要
本スクリプトは、Kaggleの「Map-Charting Student Math Misunderstandings」コンペティション用のGPU最適化版機械学習モデルです。生徒の数学問題に対する誤答パターンを分析し、その背後にある誤解を予測することを目的としています。

## 主要な特徴
- GPU（CUDA）を活用した高速処理
- 並列処理による効率的なテキストクリーニング
- XGBoostのGPUサポートを最大限活用
- MAP@3（Mean Average Precision at 3）評価指標の実装

## コード構成

### 1. インポートと初期設定（1-27行目）
```python
import cudf  # GPU対応のデータフレーム
import cuml  # GPU対応の機械学習ライブラリ
os.environ['CUDA_VISIBLE_DEVICES'] = '0'  # GPU0を使用
```
- cuDF/cuMLライブラリを使用してGPU上でデータ処理を実行
- 警告メッセージを抑制

### 2. テキストクリーニング関数（28-69行目）

#### `clean_batch(batch)`
バッチ単位でテキストをクリーニングする関数：
- 数式パターンの検出と変換（分数表記など）
- 数学記号の検出と単語化（+, -, *, ÷, =）
- 改行・余分な空白の除去
- 英数字以外の文字の除去

#### `parallel_clean(texts, n_jobs=None)`
並列処理でテキストクリーニングを実行：
- CPUコア数に応じてバッチ分割
- multiprocessing.Poolで並列実行

### 3. 特徴量抽出関数（71-119行目）

#### `extract_features_batch(df, is_train=True)`
GPU上で基本的な特徴量を抽出：
- テキスト長特徴（回答、説明、質問の文字数）
- 比率特徴（説明/質問、回答/質問、説明/回答の比率）
- cuDFを使用してGPU上で高速計算

#### `extract_math_features_parallel(texts)`
数学的特徴を並列抽出：
- 分数の出現回数
- 数値の出現回数
- 演算子の出現回数
- 括弧の出現回数
- 小数の出現回数
- 変数の出現回数

### 4. 評価指標（121-131行目）

#### `map3(target_list, pred_list)`
MAP@3（Mean Average Precision at 3）の計算：
- 1位予測が正解：スコア1.0
- 2位予測が正解：スコア0.5
- 3位予測が正解：スコア0.33

### 5. メイン処理（133-355行目）

#### データ読み込みと前処理（150-186行目）
- cuDFでCSVファイルを高速読み込み
- 欠損値処理とターゲット変数の作成
- テキストの結合（質問、回答、説明）
- 並列テキストクリーニング

#### 特徴量エンジニアリング（187-257行目）
- GPU活用による特徴量抽出
- TF-IDF特徴量の作成（n-gram: 1-3、最大5000特徴）
- 数値特徴量とTF-IDF特徴量の結合

#### XGBoostモデル訓練（260-323行目）
GPU最適化パラメータ：
- `tree_method: 'gpu_hist'` - GPU用ヒストグラム構築
- `predictor: 'gpu_predictor'` - GPU予測器
- `max_bin: 2048` - GPUメモリ効率を考慮
- `single_precision_histogram: True` - 単精度でメモリ節約

5分割交差検証の実装：
- StratifiedKFoldで層化分割
- 各フォールドで1500ラウンド学習（早期停止あり）

#### 評価と提出ファイル作成（324-355行目）
- 検証データでの精度、F1スコア、MAP@3の計算
- テストデータの予測（上位3候補）
- 提出ファイルの作成

## GPU最適化のポイント

1. **データ読み込み**: cuDFによる高速CSV読み込み
2. **特徴量計算**: GPU上でのベクトル化演算
3. **XGBoost設定**: GPU専用パラメータの最適化
4. **メモリ管理**: 単精度演算とバッチ処理でメモリ効率化

## パフォーマンス向上のための工夫

1. **並列処理**: テキストクリーニングをCPU並列化
2. **特徴量削減**: TF-IDF特徴を5000に制限
3. **GPUメモリ最適化**: max_bin=2048で使用量削減
4. **バッチ処理**: 大規模データを効率的に処理

## 使用上の注意

- CUDA対応GPUが必要
- cuDF/cuMLライブラリのインストールが必要
- 大量のGPUメモリを使用（推奨：16GB以上）
- 学習時間：GPU使用で大幅に短縮（CPUの約10分の1）

## 改善可能な点

1. 複数GPUへの対応
2. より高度な数学的特徴の抽出
3. アンサンブル手法の追加
4. ハイパーパラメータの自動調整