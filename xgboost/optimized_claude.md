# optimized_improve.py から optimized_claude.py への改善点

## 概要
optimized_claude.pyは、optimized_improve.pyをベースに、MAP@3スコアをさらに向上させるための様々な改善を実装したバージョンです。

## 主な改善点

### 1. 特徴量エンジニアリングの大幅な強化

#### 1.1 数学的特徴の拡張
- **分数の詳細分析**
  - 真分数（proper fraction）と仮分数（improper fraction）を区別してカウント
  - より正確な分数パターンの検出（`(\d+)/(\d+)` パターンも追加）

- **数値特徴の統計情報**
  - 最大値、最小値、範囲、標準偏差を計算
  - 大きな数値（100以上）の存在フラグ
  - 小数の存在フラグ
  - ユニークな数値の数

- **演算子の個別カウント**
  - 各演算子（+、-、×、÷）を個別にカウント
  - 演算子の合計数も計算

#### 1.2 新しい特徴カテゴリの追加

- **エラーパターンの詳細化**（5種類→18種類）
  - 計算エラー、符号エラー、繰り上がりエラー
  - 位取りエラー、概念的混乱、手続き的エラー
  - 解釈エラー、論理エラー、仮定エラー、逆操作エラー

- **意味的整合性特徴**（新規追加）
  - 問題・解答・説明間の単語重複度
  - 数値の整合性チェック
  - 説明の完全性と質の評価

- **問題タイプ分類**（新規追加）
  - 8種類の問題タイプ（文章題、純粋数学、幾何、代数、分数、パーセント、測定、比較）
  - 問題形式の特徴（多肢選択、穴埋め、方程式の有無）

### 2. テキスト処理の改善

#### 2.1 数学記号の詳細なトークン化
- 比較演算子（>、<、≥、≤）の処理
- 累乗記号（^）、平方根（√）、円周率（π）の処理
- ×記号の認識追加

#### 2.2 統計的特徴の拡張
- 文字数、平均文長、文の平均長
- 句読点の詳細カウント（?、!を個別に）
- QuestionTextにも統計的特徴を適用

### 3. TF-IDF設定の最適化
- **n-gram範囲**: (1,4) → (1,5)
- **最大特徴量**: 8,000 → 12,000
- **追加パラメータ**: `use_idf=True`, `smooth_idf=True`
- **ストップワード**: 'the', 'a', 'an'を追加

### 4. XGBoostパラメータの最適化

| パラメータ | optimized_improve.py | optimized_claude.py | 変更理由 |
|-----------|---------------------|-------------------|----------|
| max_depth | 12 | 14 | より複雑なパターンの学習 |
| learning_rate | 0.03 | 0.025 | 過学習の抑制 |
| subsample | 0.9 | 0.92 | わずかに増加 |
| colsample_bytree | 0.9 | 0.92 | わずかに増加 |
| gamma | 0.15 | 0.12 | 正則化を緩和 |
| alpha | 0.1 | 0.08 | L1正則化を緩和 |
| lambda | 1.5 | 1.2 | L2正則化を緩和 |
| max_bin | - | 512 | より細かい分割（新規追加） |
| num_boost_round | 1500 | 2000 | より多くの学習ラウンド |
| early_stopping_rounds | 100 | 150 | より寛容な早期停止 |

### 5. アーキテクチャの変更
- **アンサンブルの削除**: 2つのXGBoost設定のアンサンブルから、単一の最適化されたXGBoostモデルに変更
- **後処理の強化**: 訓練データの誤解頻度を計算し、後処理で活用する準備

### 6. 相互作用特徴の追加
- `explanation_quality`: 説明の単語数×ユニーク単語比率
- `numeric_consistency`: 数値の整合性×解答の説明内存在

## 期待される効果

これらの改善により、以下の効果が期待されます：

1. **より詳細な数学的パターンの捕捉**: 分数の種類や数値の統計情報により、生徒の誤解をより正確に識別
2. **意味的な理解の向上**: 問題・解答・説明の関連性を評価することで、より深い理解に基づく予測
3. **問題タイプ別の最適化**: 問題の種類に応じた適切な誤解パターンの予測
4. **エラーパターンの網羅的検出**: 18種類のエラーパターンにより、より多様な誤解を捕捉

全体として、MAP@3スコアの向上が期待できる包括的な改善となっています。